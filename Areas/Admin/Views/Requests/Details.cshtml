@model Request
@{
    ViewData["Title"] = "تفاصيل الطلب";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>تفاصيل الطلب</h3>
    <a href="/Admin/Requests" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-right me-2"></i>
        العودة للقائمة
    </a>
</div>

<!-- Request Status Actions -->
<div class="card-admin mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    حالة الطلب:
                    @switch (Model.Status)
                    {
                        case RequestStatus.Pending:
                            <span class="badge bg-warning fs-6">في الانتظار</span>
                            break;
                        case RequestStatus.Approved:
                            <span class="badge bg-success fs-6">معتمد</span>
                            break;
                        case RequestStatus.Rejected:
                            <span class="badge bg-danger fs-6">مرفوض</span>
                            break;
                        case RequestStatus.Postponed:
                            <span class="badge bg-secondary fs-6">مؤجل</span>
                            break;
                        case RequestStatus.ModificationPending:
                            <span class="badge bg-info fs-6">تعديل قيد المراجعة</span>
                            break;
                    }
                    @if (Model.IsModified)
                    {
                        <small class="text-muted ms-2">
                            <i class="fas fa-edit"></i>
                            تم التعديل @Model.ModificationCount مرة
                        </small>
                    }
                </h5>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-flex gap-2 justify-content-end flex-wrap">
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @* حالة: في الانتظار (Pending) *@
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @if (Model.Status == RequestStatus.Pending)
                    {
                        <form method="post" asp-action="UpdateStatus" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="status" value="2" />
                            <input type="hidden" name="adminNotes" value="تم اعتماد الطلب" />
                            <button type="submit" class="btn btn-success" onclick="return confirm('هل أنت متأكد من اعتماد هذا الطلب؟')">
                                <i class="fas fa-check me-1"></i>
                                موافقة
                            </button>
                        </form>

                        <form method="post" asp-action="UpdateStatus" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="status" value="4" />
                            <input type="hidden" name="adminNotes" value="تم تأجيل الطلب" />
                            <button type="submit" class="btn btn-warning" onclick="return confirm('هل أنت متأكد من تأجيل هذا الطلب؟')">
                                <i class="fas fa-pause me-1"></i>
                                تأجيل
                            </button>
                        </form>

                        <button type="button" class="btn btn-danger" onclick="showRejectModal(@Model.Id)">
                            <i class="fas fa-times me-1"></i>
                            رفض
                        </button>
                    }

                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @* حالة: تعديل قيد المراجعة (ModificationPending) *@
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @if (Model.Status == RequestStatus.ModificationPending)
                    {
                        <div class="alert alert-info p-2 mb-0 me-2 d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>طلب معدّل يحتاج مراجعة</small>
                        </div>

                        <form method="post" asp-action="ApproveModification" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-success" onclick="return confirm('هل أنت متأكد من اعتماد التعديلات على هذا الطلب؟')">
                                <i class="fas fa-check-double me-1"></i>
                                اعتماد التعديل
                            </button>
                        </form>

                        <button type="button" class="btn btn-danger" onclick="showRejectModificationModal(@Model.Id)">
                            <i class="fas fa-times me-1"></i>
                            رفض التعديل
                        </button>
                    }

                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @* حالة: مؤجل (Postponed) *@
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @if (Model.Status == RequestStatus.Postponed)
                    {
                        <form method="post" asp-action="UpdateStatus" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="status" value="2" />
                            <input type="hidden" name="adminNotes" value="تم اعتماد الطلب بعد التأجيل" />
                            <button type="submit" class="btn btn-success" onclick="return confirm('هل أنت متأكد من اعتماد هذا الطلب المؤجل؟')">
                                <i class="fas fa-check me-1"></i>
                                اعتماد الطلب
                            </button>
                        </form>

                        <button type="button" class="btn btn-danger" onclick="showRejectModal(@Model.Id)">
                            <i class="fas fa-times me-1"></i>
                            رفض
                        </button>
                    }

                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @* حالة: معتمد (Approved) *@
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @if (Model.Status == RequestStatus.Approved)
                    {
                        <form method="post" asp-action="ToggleRequestStatus" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-warning" onclick="return confirm('هل أنت متأكد من إيقاف هذا الطلب؟')">
                                <i class="fas fa-pause me-1"></i>
                                إيقاف الطلب
                            </button>
                        </form>
                    }

                    @* ═══════════════════════════════════════════════════════════════════ *@
                    @* أزرار التعديل والحذف متاحة لجميع الحالات *@
                    @* ═══════════════════════════════════════════════════════════════════ *@
                    <a href="/Admin/Requests/Edit/@Model.Id" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i>
                        تعديل
                    </a>

                    <form method="post" asp-action="Delete" style="display: inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-danger" onclick="return confirm('هل أنت متأكد من حذف هذا الطلب نهائياً؟ لا يمكن التراجع عن هذا الإجراء!')">
                            <i class="fas fa-trash me-1"></i>
                            حذف
                        </button>
                    </form>
                </div>
            </div>
        </div>

        @* ═══════════════════════════════════════════════════════════════════ *@
        @* عرض معلومات التعديل إذا كان الطلب معدّل *@
        @* ═══════════════════════════════════════════════════════════════════ *@
        @if (Model.IsModified && Model.LastModifiedAt.HasValue)
        {
            <hr>
            <div class="alert alert-warning">
                <i class="fas fa-history me-2"></i>
                <strong>معلومات التعديل:</strong>
                <ul class="mb-0 mt-2">
                    <li>عدد مرات التعديل: <strong>@Model.ModificationCount</strong></li>
                    <li>آخر تعديل: <strong>@Model.LastModifiedAt.Value.ToString("dd/MM/yyyy - hh:mm tt")</strong></li>
                </ul>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.AdminNotes))
        {
            <hr>
            <div class="alert alert-info">
                <strong>ملاحظات الإدارة:</strong><br>
                @Model.AdminNotes
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.RejectionReason))
        {
            <hr>
            <div class="alert alert-danger">
                <strong>سبب الرفض:</strong><br>
                @Model.RejectionReason
            </div>
        }
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Request Details -->
        <div class="card-admin mb-4">
            <div class="card-body">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    تفاصيل الطلب
                </h5>

                <h4 class="mb-3">@Model.Title</h4>

                <div class="mb-3">
                    <div class="d-flex gap-2 mb-2">
                        <span class="badge bg-primary">@Model.Category?.Name</span>
                        @if (Model.SubCategory1 != null)
                        {
                            <span class="badge bg-secondary">@Model.SubCategory1.Name</span>
                        }
                        @if (Model.SubCategory2 != null)
                        {
                            <span class="badge bg-info">@Model.SubCategory2.Name</span>
                        }
                    </div>
                </div>

                <p class="lead">@Model.Description</p>

                <div class="bg-light p-3 rounded">
                    <h6><i class="fas fa-map-marker-alt me-2 text-primary"></i>الموقع</h6>
                    <p class="mb-1"><strong>المحافظة:</strong> @Model.City</p>
                    <p class="mb-1"><strong>المنطقة:</strong> @Model.District</p>
                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <p class="mb-0"><strong>العنوان التفصيلي:</strong> @Model.Location</p>
                    }
                </div>
            </div>
        </div>

        <!-- Images -->
        @if (Model.Images != null && Model.Images.Any())
        {
            <div class="card-admin mb-4">
                <div class="card-body">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-images me-2"></i>
                        صور الطلب (@Model.Images.Count)
                    </h5>

                    <div class="row g-3">
                        @foreach (var image in Model.Images)
                        {
                            <div class="col-md-4">
                                <img src="@image.ImagePath" class="img-fluid rounded"
                                     style="height: 200px; object-fit: cover; width: 100%; cursor: pointer;"
                                     alt="صورة الطلب" data-bs-toggle="modal" data-bs-target="#imageModal"
                                     onclick="showImage('@image.ImagePath')">
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="col-lg-4">
        <!-- Customer Info -->
        <div class="card-admin mb-4">
            <div class="card-body">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-user me-2"></i>
                    معلومات العميل
                </h5>

                <div class="text-center mb-3">
                    @if (!string.IsNullOrEmpty(Model.User?.ProfileImage))
                    {
                        <img src="@Model.User.ProfileImage" class="rounded-circle mb-2"
                             style="width: 80px; height: 80px; object-fit: cover;" alt="صورة العميل">
                    }
                    else
                    {
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                             style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                    }
                    <h6>@Model.User?.FirstName @Model.User?.LastName</h6>
                    <p class="text-muted small">عضو منذ @Model.User?.CreatedAt.ToString("MM/yyyy")</p>
                </div>

                <div class="d-grid gap-2">
                    <a href="tel:@Model.User?.PhoneNumber" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-phone me-1"></i>
                        @Model.User?.PhoneNumber
                    </a>
                    <a href="https://wa.me/@Model.User?.PhoneNumber?.Replace("+", "")" target="_blank"
                       class="btn btn-success btn-sm">
                        <i class="fab fa-whatsapp me-1"></i>
                        واتساب
                    </a>
                    @if (!string.IsNullOrEmpty(Model.User?.Email))
                    {
                        <a href="mailto:@Model.User.Email" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-envelope me-1"></i>
                            بريد إلكتروني
                        </a>
                    }
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="card-admin">
            <div class="card-body">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-history me-2"></i>
                    التسلسل الزمني
                </h5>

                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6>تم إنشاء الطلب</h6>
                            <small class="text-muted">@Model.CreatedAt.ToString("dd/MM/yyyy - hh:mm tt")</small>
                        </div>
                    </div>

                    @if (Model.IsModified && Model.LastModifiedAt.HasValue)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6>تم تعديل الطلب</h6>
                                <small class="text-muted">@Model.LastModifiedAt.Value.ToString("dd/MM/yyyy - hh:mm tt")</small>
                            </div>
                        </div>
                    }

                    @if (Model.Status == RequestStatus.Approved && Model.ApprovedAt.HasValue)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6>تم اعتماد الطلب</h6>
                                <small class="text-muted">@Model.ApprovedAt.Value.ToString("dd/MM/yyyy - hh:mm tt")</small>
                            </div>
                        </div>
                    }

                    @if (Model.Status == RequestStatus.Rejected)
                    {
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <h6>تم رفض الطلب</h6>
                                <small class="text-muted">@(!string.IsNullOrEmpty(Model.RejectionReason) ? Model.RejectionReason : "بدون سبب محدد")</small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">عرض الصورة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="صورة الطلب">
            </div>
        </div>
    </div>
</div>

<!-- Reject Request Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times me-2"></i>
                    رفض الطلب
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form id="rejectForm" method="post" asp-action="RejectRequest">
                @Html.AntiForgeryToken()
                <input type="hidden" id="rejectRequestId" name="id" value="" />
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تنبيه:</strong> سيتم إرسال إشعار للمستخدم بسبب الرفض عبر الموقع والبريد الإلكتروني والواتساب.
                    </div>

                    <div class="mb-3">
                        <label for="rejectionReason" class="form-label fw-bold">
                            <i class="fas fa-comment me-2"></i>
                            سبب الرفض <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="rejectionReason" name="rejectionReason" rows="4"
                                  placeholder="يرجى كتابة سبب واضح ومفصل لرفض هذا الطلب..." required></textarea>
                        <div class="form-text">
                            سيتم إرسال هذا السبب للمستخدم، لذا يرجى كتابة سبب واضح ومهذب.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">أسباب شائعة:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setReason('الطلب غير واضح أو ناقص المعلومات')">
                                طلب غير واضح
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setReason('الطلب يخالف شروط الاستخدام')">
                                يخالف الشروط
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setReason('معلومات الاتصال غير صحيحة')">
                                معلومات خاطئة
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setReason('طلب مكرر')">
                                طلب مكرر
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-2"></i>
                        تأكيد الرفض
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modification Modal -->
<div class="modal fade" id="rejectModificationModal" tabindex="-1" aria-labelledby="rejectModificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModificationModalLabel">
                    <i class="fas fa-times me-2"></i>
                    رفض التعديل
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form id="rejectModificationForm" method="post" asp-action="RejectModification">
                @Html.AntiForgeryToken()
                <input type="hidden" id="rejectModificationRequestId" name="id" value="" />
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>ملاحظة:</strong> سيتم إعادة الطلب لحالة "قيد المراجعة" مع إرسال إشعار للمستخدم بسبب رفض التعديل.
                    </div>

                    <div class="mb-3">
                        <label for="modificationRejectionReason" class="form-label fw-bold">
                            <i class="fas fa-comment me-2"></i>
                            سبب رفض التعديل <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="modificationRejectionReason" name="rejectionReason" rows="4"
                                  placeholder="يرجى كتابة سبب واضح لرفض التعديلات..." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">أسباب شائعة:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModificationReason('التعديلات غير مناسبة')">
                                تعديلات غير مناسبة
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModificationReason('المعلومات لا تزال غير واضحة')">
                                معلومات غير واضحة
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setModificationReason('الصور غير مناسبة')">
                                صور غير مناسبة
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-2"></i>
                        تأكيد رفض التعديل
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showImage(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
        }

        function showRejectModal(requestId) {
            document.getElementById('rejectRequestId').value = requestId;
            document.getElementById('rejectionReason').value = '';
            var modal = new bootstrap.Modal(document.getElementById('rejectModal'));
            modal.show();
        }

        function showRejectModificationModal(requestId) {
            document.getElementById('rejectModificationRequestId').value = requestId;
            document.getElementById('modificationRejectionReason').value = '';
            var modal = new bootstrap.Modal(document.getElementById('rejectModificationModal'));
            modal.show();
        }

        function setReason(reason) {
            document.getElementById('rejectionReason').value = reason;
        }

        function setModificationReason(reason) {
            document.getElementById('modificationRejectionReason').value = reason;
        }

        // تحسين تجربة المستخدم
        document.addEventListener('DOMContentLoaded', function() {
            // نموذج الرفض
            const rejectForm = document.getElementById('rejectForm');
            if (rejectForm) {
                rejectForm.addEventListener('submit', function(e) {
                    const reason = document.getElementById('rejectionReason').value.trim();
                    if (reason.length < 10) {
                        e.preventDefault();
                        alert('يرجى كتابة سبب مفصل للرفض (على الأقل 10 أحرف)');
                        return false;
                    }
                    if (!confirm('هل أنت متأكد من رفض هذا الطلب؟')) {
                        e.preventDefault();
                        return false;
                    }
                    const submitBtn = rejectForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الرفض...';
                });
            }

            // نموذج رفض التعديل
            const rejectModificationForm = document.getElementById('rejectModificationForm');
            if (rejectModificationForm) {
                rejectModificationForm.addEventListener('submit', function(e) {
                    const reason = document.getElementById('modificationRejectionReason').value.trim();
                    if (reason.length < 10) {
                        e.preventDefault();
                        alert('يرجى كتابة سبب مفصل لرفض التعديل (على الأقل 10 أحرف)');
                        return false;
                    }
                    if (!confirm('هل أنت متأكد من رفض تعديلات هذا الطلب؟')) {
                        e.preventDefault();
                        return false;
                    }
                    const submitBtn = rejectModificationForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الرفض...';
                });
            }
        });
    </script>
}

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-marker {
        position: absolute;
        left: -23px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #e9ecef;
    }

    .timeline-content h6 {
        margin-bottom: 2px;
        font-size: 14px;
    }
</style>
