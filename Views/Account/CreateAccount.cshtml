@model CreateAccountViewModel
@inject IStringLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["CreateNewAccount"];
        Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-custom">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="card-custom mb-4">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="progress-step completed">
                        <div class="step-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <span>@Localizer["PhoneVerification"]</span>
                    </div>
                    <div class="progress-line completed"></div>
                    <div class="progress-step active">
                        <div class="step-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <span>@Localizer["CreateAccount"]</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>@Localizer["Complete"]</span>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="text-center mb-4">
                    <i class="fas fa-user-plus fa-3x text-primary mb-3"></i>
                    <h1 class="h3 text-primary">@Localizer["CreateNewAccount"]</h1>
                    <p class="text-muted">@Localizer["CompleteYourData"]</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        @Localizer["VerifiedPhoneNumber"]: <strong>@ViewBag.PhoneNumber</strong>
                    </div>
                </div>

                <form asp-action="CreateAccount" method="post" enctype="multipart/form-data" id="createAccountForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- Personal Information -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-user me-2"></i>
                            @Localizer["PersonalInformation"]
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label">@Localizer["FirstName"] *</label>
                                <input asp-for="FirstName" class="form-control" required>
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label">@Localizer["LastName"] *</label>
                                <input asp-for="LastName" class="form-control" required>
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="DateOfBirth" class="form-label">@Localizer["DateOfBirth"] *</label>
                                <input asp-for="DateOfBirth" type="date" class="form-control" required>
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Gender" class="form-label">@Localizer["Gender"] *</label>
                                <select asp-for="Gender" class="form-control" required>
                                    <option value="">@Localizer["SelectGender"]</option>
                                    <option value="Male">@Localizer["Male"]</option>
                                    <option value="Female">@Localizer["Female"]</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Email" class="form-label">@Localizer["Email"]</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="@Localizer["Optional"]">
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            @Localizer["LocationInfo"]
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="City" class="form-label">@Localizer["City"] *</label>
                                <select asp-for="City" class="form-control" required>
                                    <option value="">@Localizer["SelectCity"]</option>
                                    <option value="Baghdad">@Localizer["Baghdad"]</option>
                                    <option value="Basra">@Localizer["Basra"]</option>
                                    <option value="Erbil">@Localizer["Erbil"]</option>
                                    <option value="Najaf">@Localizer["Najaf"]</option>
                                    <option value="Karbala">@Localizer["Karbala"]</option>
                                    <option value="Mosul">@Localizer["Mosul"]</option>
                                    <option value="Sulaymaniyah">@Localizer["Sulaymaniyah"]</option>
                                    <option value="Babylon">@Localizer["Babylon"]</option>
                                    <option value="Dohuk">@Localizer["Dohuk"]</option>
                                    <option value="Kirkuk">@Localizer["Kirkuk"]</option>
                                    <option value="Anbar">@Localizer["Anbar"]</option>
                                    <option value="Diyala">@Localizer["Diyala"]</option>
                                    <option value="Saladin">@Localizer["Saladin"]</option>
                                    <option value="Wasit">@Localizer["Wasit"]</option>
                                    <option value="ThiQar">@Localizer["ThiQar"]</option>
                                    <option value="Muthanna">@Localizer["Muthanna"]</option>
                                    <option value="Qadisiyyah">@Localizer["Qadisiyyah"]</option>
                                    <option value="Maysan">@Localizer["Maysan"]</option>
                                </select>
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="District" class="form-label">@Localizer["District"] *</label>
                                <input asp-for="District" class="form-control" placeholder="@Localizer["DistrictExample"]" required>
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Location" class="form-label">@Localizer["DetailedAddress"]</label>
                                <input asp-for="Location" class="form-control" placeholder="@Localizer["AddressOptional"]">
                            </div>
                        </div>
                    </div>

                    <!-- Account Type -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-user-tag me-2"></i>
                            @Localizer["AccountType"]
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="1">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                        <h5>@Localizer["Buyer"]</h5>
                                        <p class="text-muted">@Localizer["BuyerDescription"]</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="2">
                                    <div class="card-body text-center">
                                        <i class="fas fa-store fa-3x text-success mb-3"></i>
                                        <h5>@Localizer["Seller"]</h5>
                                        <p class="text-muted">@Localizer["SellerDescription"]</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input asp-for="UserType" type="hidden" id="userTypeInput">
                        <span asp-validation-for="UserType" class="text-danger"></span>
                    </div>

                    <!-- Store Information (for sellers) -->
                    <div id="storeInfo" class="form-section" style="display: none;">
                        <h5 class="section-title">
                            <i class="fas fa-store me-2"></i>
                            @Localizer["StoreInfo"]
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="StoreName" class="form-label">@Localizer["StoreName"] *</label>
                                <input asp-for="StoreName" class="form-control" placeholder="@Localizer["YourStoreName"]" id="storeNameInput">
                                <span asp-validation-for="StoreName" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>ملاحظة مهمة:</strong> يرجى اختيار التخصص الدقيق لمتجرك من الفئة الفرعية الثانية للحصول على طلبات أكثر دقة.
                                </div>
                            </div>

                            <!-- Cascading Category Selection -->
                            <div class="col-md-4">
                                <label for="categorySelect" class="form-label">الفئة الأساسية *</label>
                                <select id="categorySelect" class="form-control">
                                    <option value="">اختر الفئة الأساسية</option>
                                    @foreach (var category in ViewBag.Categories as List<Category>)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="subCategory1Select" class="form-label">الفئة الفرعية الأولى *</label>
                                <select id="subCategory1Select" class="form-control" disabled>
                                    <option value="">اختر الفئة الفرعية الأولى</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="subCategory2Select" class="form-label">التخصص الدقيق *</label>
                               @*  <select id="subCategory2Select" class="form-control" disabled multiple size="5"> *@
                                <select id="subCategory2Select" class="mobile-multi-select" disabled multiple
                                        data-placeholder="اختر التخصصات الدقيقة..."
                                        data-search-placeholder="البحث في التخصصات..."
                                        data-no-results="لا توجد تخصصات متاحة"
                                        data-clear-all="مسح جميع الاختيارات"
                                        data-max-tags="3"
                                        data-enable-search="true"
                                        data-enable-clear-all="true">
                                    <option value="">اختر التخصص الدقيق</option>
                                </select>
                          @*       <div class="form-text">يمكنك اختيار أكثر من تخصص (استخدم Ctrl للاختيار المتعدد)</div> *@

                                <div class="form-text">
                                    <i class="fas fa-touch me-1"></i>
                                    اضغط لاختيار تخصصات متعددة
                            </div>

                            <!-- Hidden field to store selected SubCategory2 IDs -->
                            <input type="hidden" asp-for="StoreCategories" id="storeCategoriesHidden" />
                            <span asp-validation-for="StoreCategories" class="text-danger"></span>

                            <div class="col-12" id="selectedCategoriesDisplay">
                                <div class="alert alert-success" style="display: none;">
                                    <strong><i class="fas fa-check-circle me-2"></i>التخصصات المختارة:</strong>
                                    <div id="selectedCategoriesList" class="mt-2"></div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label asp-for="StoreDescription" class="form-label">@Localizer["StoreDescription"]</label>
                                <textarea asp-for="StoreDescription" class="form-control" rows="3"
                                          placeholder="@Localizer["StoreDescriptionPlaceholder"]"></textarea>
                                <span asp-validation-for="StoreDescription" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl1" class="form-label">@Localizer["WebsiteUrl1"]</label>
                                <input asp-for="WebsiteUrl1" class="form-control" placeholder="https://example.com">
                                <span asp-validation-for="WebsiteUrl1" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl2" class="form-label">@Localizer["WebsiteUrl2"]</label>
                                <input asp-for="WebsiteUrl2" class="form-control" placeholder="https://facebook.com/yourstore">
                                <span asp-validation-for="WebsiteUrl2" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl3" class="form-label">@Localizer["WebsiteUrl3"]</label>
                                <input asp-for="WebsiteUrl3" class="form-control" placeholder="https://instagram.com/yourstore">
                                <span asp-validation-for="WebsiteUrl3" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Image -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-camera me-2"></i>
                            @Localizer["ProfileImage"]
                        </h5>

                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="ProfileImage" class="form-label">@Localizer["SelectProfileImage"]</label>
                                <input asp-for="ProfileImage" type="file" class="form-control" accept="image/*"
                                       onchange="previewProfileImage(this)">
                                <div class="form-text">@Localizer["ProfileImageNote"]</div>
                                <span asp-validation-for="ProfileImage" class="text-danger"></span>

                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <img id="preview" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;" alt="@Localizer["ImagePreview"]">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="form-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/Account/Login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-2"></i>
                                @Localizer["Back"]
                            </a>
                            <button type="submit" class="btn btn-custom btn-lg" id="submitBtn">
                                <i class="fas fa-user-plus me-2"></i>
                                @Localizer["CreateAccount"]
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

        .form-section:last-child {
            border-bottom: none;
        }

    .section-title {
        color: #b3962d;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        flex: 1;
    }

    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .progress-step.completed .step-icon {
        background: #b3962d;
        color: white;
    }

    .progress-step.active .step-icon {
        background: var(--secondary-color);
        color: white;
    }

    .progress-line {
        height: 2px;
        background: #e9ecef;
        flex: 1;
        margin: 25px 20px 0;
        transition: all 0.3s ease;
    }

        .progress-line.completed {
            background: #b3962d;
        }

    .account-type-card {
        border: 2px solid var(--border-color);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
    }

        .account-type-card:hover {
            border-color: #b3962d;
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.1);
        }

        .account-type-card.selected {
            border-color: #b3962d;
            background: rgba(44, 90, 160, 0.05);
        }

        .account-type-card .card-body {
            padding: 2rem;
        }

    #subCategory2Select {
        min-height: 120px;
    }

    #selectedCategoriesList ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #selectedCategoriesList li {
        padding: 8px 0;
        border-bottom: 1px dashed #d4edda;
    }

        #selectedCategoriesList li:last-child {
            border-bottom: none;
        }

    @@media (max-width: 768px) {
        .progress-step span {
            font-size: 0.8rem;
        }

        .progress-line {
            margin: 25px 10px 0;
        }
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // ✅ متغير عام لتخزين الفئات المختارة
        var selectedCategories = new Map();

        document.addEventListener('DOMContentLoaded', function() {

            // ✅ اختيار نوع الحساب
            document.querySelectorAll('.account-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    // إزالة الاختيار من كل البطاقات
                    document.querySelectorAll('.account-type-card').forEach(c => {
                        c.classList.remove('selected');
                    });

                    // إضافة الاختيار للبطاقة الحالية
                    this.classList.add('selected');

                    const userType = this.getAttribute('data-type');
                    document.getElementById('userTypeInput').value = userType;
                    const storeInfo = document.getElementById('storeInfo');

                    if (userType === '2') { // Seller - بائع
                        storeInfo.style.display = 'block';
                        document.getElementById('storeNameInput').required = true;
                    } else { // Buyer - مشتري
                        storeInfo.style.display = 'none';
                        document.getElementById('storeNameInput').required = false;

                        // ✅ مسح القيم المختارة للفئات عند اختيار مشتري
                        selectedCategories.clear();
                        document.getElementById('categorySelect').value = '';
                        document.getElementById('subCategory1Select').innerHTML = '<option value="">اختر الفئة الفرعية الأولى</option>';
                        document.getElementById('subCategory1Select').disabled = true;
                        document.getElementById('subCategory2Select').innerHTML = '<option value="">اختر التخصص الدقيق</option>';
                        document.getElementById('subCategory2Select').disabled = true;
                        document.getElementById('storeCategoriesHidden').value = '';
                        document.querySelector('#selectedCategoriesDisplay .alert').style.display = 'none';
                    }
                });
            });

            // ✅ Cascading dropdown - الفئة الأساسية
            $('#categorySelect').change(function() {
                var categoryId = $(this).val();
                var $subCategory1 = $('#subCategory1Select');
                var $subCategory2 = $('#subCategory2Select');

                // إعادة تعيين الفئات الفرعية
                $subCategory1.html('<option value="">اختر الفئة الفرعية الأولى</option>').prop('disabled', true);
                $subCategory2.html('<option value="">اختر التخصص الدقيق</option>').prop('disabled', true);

                if (categoryId) {
                    $.ajax({
                        url: '/Requests/GetSubCategories1',
                        data: { categoryId: categoryId },
                        success: function(data) {
                            if (data && data.length > 0) {
                                $subCategory1.prop('disabled', false);
                                $.each(data, function(i, item) {
                                    $subCategory1.append($('<option>', {
                                        value: item.id,
                                        text: item.name
                                    }));
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('خطأ في جلب الفئات الفرعية:', error);
                        }
                    });
                }
            });

            // ✅ Cascading dropdown - الفئة الفرعية الأولى
            $('#subCategory1Select').change(function() {
                var subCategory1Id = $(this).val();
                var $subCategory2 = $('#subCategory2Select');

                $subCategory2.html('<option value="">اختر التخصص الدقيق</option>').prop('disabled', true);

                if (subCategory1Id) {
                    $.ajax({
                        url: '/Requests/GetSubCategories2',
                        data: { subCategory1Id: subCategory1Id },
                        success: function(data) {
                            if (data && data.length > 0) {
                                $subCategory2.prop('disabled', false);
                                $.each(data, function(i, item) {
                                    $subCategory2.append($('<option>', {
                                        value: item.id,
                                        text: item.name
                                    }));
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('خطأ في جلب التخصصات:', error);
                        }
                    });
                }
            });

            // ✅ معالجة اختيار التخصص الدقيق (SubCategory2)
            $('#subCategory2Select').change(function() {
                var selectedOptions = $(this).find('option:selected');
                var categoryName = $('#categorySelect option:selected').text();
                var subCategory1Name = $('#subCategory1Select option:selected').text();
                var currentSubCat1 = $('#subCategory1Select').val();

                // إضافة الفئات المختارة الجديدة
                selectedOptions.each(function() {
                    var id = $(this).val();
                    var name = $(this).text();
                    if (id && id !== '') {
                        var fullPath = categoryName + ' > ' + subCategory1Name + ' > ' + name;
                        selectedCategories.set(id, {
                            id: id,
                            path: fullPath,
                            subCategory1Id: currentSubCat1
                        });
                    }
                });

                updateSelectedCategoriesDisplay();
            });

            // ✅ التحقق عند إرسال النموذج
            document.getElementById('createAccountForm').addEventListener('submit', function(e) {
                const userType = document.getElementById('userTypeInput').value;

                if (!userType) {
                    e.preventDefault();
                    showAlert('@Localizer["SelectAccountType"]', 'warning');
                    return false;
                }

                // التحقق من حقول البائع
                if (userType === '2') {
                    const storeName = document.getElementById('storeNameInput').value;

                    if (!storeName.trim()) {
                        e.preventDefault();
                        showAlert('@Localizer["EnterStoreName"]', 'warning');
                        return false;
                    }

                    if (selectedCategories.size === 0) {
                        e.preventDefault();
                        showAlert('يرجى اختيار تخصص واحد على الأقل للمتجر', 'warning');
                        return false;
                    }

                    // ✅ تحديث الحقل المخفي قبل الإرسال
                    var ids = Array.from(selectedCategories.values()).map(c => parseInt(c.id));
                    document.getElementById('storeCategoriesHidden').value = JSON.stringify(ids);

                    console.log('📤 الفئات المرسلة:', document.getElementById('storeCategoriesHidden').value);
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> @Localizer["CreatingAccount"]';
            });

            // تعيين حدود تاريخ الميلاد
            const dateInput = document.querySelector('[name="DateOfBirth"]');
            if (dateInput) {
                const eighteenYearsAgo = new Date();
                eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);
                dateInput.max = eighteenYearsAgo.toISOString().split('T')[0];

                const hundredYearsAgo = new Date();
                hundredYearsAgo.setFullYear(hundredYearsAgo.getFullYear() - 100);
                dateInput.min = hundredYearsAgo.toISOString().split('T')[0];
            }
        });

        // ✅ تحديث عرض الفئات المختارة
        function updateSelectedCategoriesDisplay() {
            var categoriesArray = Array.from(selectedCategories.values());
            var ids = categoriesArray.map(c => parseInt(c.id));

            // تحديث الحقل المخفي
            document.getElementById('storeCategoriesHidden').value = JSON.stringify(ids);

            console.log('📋 الفئات المختارة:', ids);

            if (categoriesArray.length > 0) {
                var html = '<ul class="list-unstyled mb-0">';
                categoriesArray.forEach(function(cat) {
                    html += '<li class="mb-1">' +
                            '<i class="fas fa-check-circle text-success me-2"></i>' +
                            cat.path +
                            ' <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeCategory(\'' + cat.id + '\')">' +
                            '<i class="fas fa-times"></i>' +
                            '</button></li>';
                });
                html += '</ul>';

                document.getElementById('selectedCategoriesList').innerHTML = html;
                document.querySelector('#selectedCategoriesDisplay .alert').style.display = 'block';
            } else {
                document.querySelector('#selectedCategoriesDisplay .alert').style.display = 'none';
            }
        }

        // ✅ إزالة فئة من القائمة
        function removeCategory(id) {
            selectedCategories.delete(id);
            updateSelectedCategoriesDisplay();

            // إلغاء تحديد الخيار في القائمة
            $('#subCategory2Select option[value="' + id + '"]').prop('selected', false);
        }

        // معاينة صورة الملف الشخصي
        function previewProfileImage(input) {
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('@Localizer["ImageTooLarge"]', 'warning');
                    input.value = '';
                    previewContainer.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        }

        // عرض رسالة تنبيه
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container-custom');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);

            alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    </script>
}
