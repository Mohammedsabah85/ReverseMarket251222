@model CreateAccountViewModel
@inject IStringLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["CreateNewAccount"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-custom">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Progress Bar -->
            <div class="card-custom mb-4">
                <div class="d-flex justify-content-center align-items-center">
                    <div class="progress-step completed">
                        <div class="step-icon"><i class="fas fa-phone"></i></div>
                        <span>@Localizer["PhoneVerification"]</span>
                    </div>
                    <div class="progress-line completed"></div>
                    <div class="progress-step active">
                        <div class="step-icon"><i class="fas fa-user"></i></div>
                        <span>@Localizer["CreateAccount"]</span>
                    </div>
                    <div class="progress-line"></div>
                    <div class="progress-step">
                        <div class="step-icon"><i class="fas fa-check"></i></div>
                        <span>@Localizer["Complete"]</span>
                    </div>
                </div>
            </div>

            <div class="card-custom">
                <div class="text-center mb-4">
                    <i class="fas fa-user-plus fa-3x text-primary mb-3"></i>
                    <h1 class="h3 text-primary">@Localizer["CreateNewAccount"]</h1>
                    <p class="text-muted">@Localizer["CompleteYourData"]</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        @Localizer["VerifiedPhoneNumber"]: <strong>@ViewBag.PhoneNumber</strong>
                    </div>
                </div>

                <form asp-action="CreateAccount" method="post" enctype="multipart/form-data" id="createAccountForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- Personal Information -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-user me-2"></i>@Localizer["PersonalInformation"]</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label">@Localizer["FirstName"] *</label>
                                <input asp-for="FirstName" class="form-control" required>
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label">@Localizer["LastName"] *</label>
                                <input asp-for="LastName" class="form-control" required>
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="DateOfBirth" class="form-label">@Localizer["DateOfBirth"] *</label>
                                <input asp-for="DateOfBirth" type="date" class="form-control" required>
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Gender" class="form-label">@Localizer["Gender"] *</label>
                                <select asp-for="Gender" class="form-control" required>
                                    <option value="">@Localizer["SelectGender"]</option>
                                    <option value="Male">@Localizer["Male"]</option>
                                    <option value="Female">@Localizer["Female"]</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Email" class="form-label">@Localizer["Email"]</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="@Localizer["Optional"]">
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-map-marker-alt me-2"></i>@Localizer["LocationInfo"]</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="City" class="form-label">@Localizer["City"] *</label>
                                <select asp-for="City" class="form-control" required>
                                    <option value="">@Localizer["SelectCity"]</option>
                                    <option value="Baghdad">@Localizer["Baghdad"]</option>
                                    <option value="Basra">@Localizer["Basra"]</option>
                                    <option value="Erbil">@Localizer["Erbil"]</option>
                                    <option value="Najaf">@Localizer["Najaf"]</option>
                                    <option value="Karbala">@Localizer["Karbala"]</option>
                                    <option value="Mosul">@Localizer["Mosul"]</option>
                                    <option value="Sulaymaniyah">@Localizer["Sulaymaniyah"]</option>
                                    <option value="Babylon">@Localizer["Babylon"]</option>
                                    <option value="Dohuk">@Localizer["Dohuk"]</option>
                                    <option value="Kirkuk">@Localizer["Kirkuk"]</option>
                                    <option value="Anbar">@Localizer["Anbar"]</option>
                                    <option value="Diyala">@Localizer["Diyala"]</option>
                                    <option value="Saladin">@Localizer["Saladin"]</option>
                                    <option value="Wasit">@Localizer["Wasit"]</option>
                                    <option value="ThiQar">@Localizer["ThiQar"]</option>
                                    <option value="Muthanna">@Localizer["Muthanna"]</option>
                                    <option value="Qadisiyyah">@Localizer["Qadisiyyah"]</option>
                                    <option value="Maysan">@Localizer["Maysan"]</option>
                                </select>
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="District" class="form-label">@Localizer["District"] *</label>
                                <input asp-for="District" class="form-control" placeholder="@Localizer["DistrictExample"]" required>
                                <span asp-validation-for="District" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Location" class="form-label">@Localizer["DetailedAddress"]</label>
                                <input asp-for="Location" class="form-control" placeholder="@Localizer["AddressOptional"]">
                            </div>
                        </div>
                    </div>

                    <!-- Account Type -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-user-tag me-2"></i>@Localizer["AccountType"]</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="1">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shopping-cart fa-3x text-primary mb-3"></i>
                                        <h5>@Localizer["Buyer"]</h5>
                                        <p class="text-muted">@Localizer["BuyerDescription"]</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="account-type-card" data-type="2">
                                    <div class="card-body text-center">
                                        <i class="fas fa-store fa-3x text-success mb-3"></i>
                                        <h5>@Localizer["Seller"]</h5>
                                        <p class="text-muted">@Localizer["SellerDescription"]</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input asp-for="UserType" type="hidden" id="userTypeInput">
                        <span asp-validation-for="UserType" class="text-danger"></span>
                    </div>

                    <!-- Store Information (for sellers) -->
                    <div id="storeInfo" class="form-section" style="display: none;">
                        <h5 class="section-title"><i class="fas fa-store me-2"></i>@Localizer["StoreInfo"]</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="StoreName" class="form-label">@Localizer["StoreName"] *</label>
                                <input asp-for="StoreName" class="form-control" placeholder="@Localizer["YourStoreName"]" id="storeNameInput">
                                <span asp-validation-for="StoreName" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <div class="alert alert-light border">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    <strong>نصيحة:</strong> اختر التخصصات الدقيقة لمتجرك للحصول على طلبات أكثر دقة. يمكنك اختيار تخصصات متعددة.
                                </div>
                            </div>

                            <!-- Cascading Category Selection -->
                            <div class="col-md-4">
                                <label for="categorySelect" class="form-label">الفئة الأساسية *</label>
                                <select id="categorySelect" class="form-control">
                                    <option value="">اختر الفئة الأساسية</option>
                                    @foreach (var category in ViewBag.Categories as List<Category>)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="subCategory1Select" class="form-label">الفئة الفرعية الأولى *</label>
                                <select id="subCategory1Select" class="form-control" disabled>
                                    <option value="">اختر الفئة الفرعية الأولى</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">التخصص الدقيق *</label>
                                <div id="subCategory2Container" class="spec-dropdown disabled">
                                    <div class="spec-dropdown-header" id="dropdownHeader">
                                        <span id="headerText">اختر التخصصات الدقيقة...</span>
                                        <i class="fas fa-chevron-down" id="dropdownArrow"></i>
                                    </div>
                                    <div class="spec-dropdown-menu" id="dropdownMenu">
                                        <div class="spec-search-box">
                                            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="ابحث...">
                                        </div>
                                        <div class="spec-options-list" id="optionsList">
                                            <div class="spec-empty-msg"><i class="fas fa-info-circle me-2"></i>اختر الفئة الفرعية أولاً</div>
                                        </div>
                                        <div class="spec-actions">
                                            <button type="button" class="btn btn-sm btn-outline-success" id="btnSelectAll">
                                                <i class="fas fa-check-double me-1"></i>تحديد الكل
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearAll">
                                                <i class="fas fa-times me-1"></i>مسح الكل
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text"><i class="fas fa-hand-pointer me-1"></i>اضغط لاختيار تخصصات متعددة</div>
                            </div>

                            <input type="hidden" asp-for="StoreCategories" id="storeCategoriesHidden" />
                            <span asp-validation-for="StoreCategories" class="text-danger"></span>

                            <!-- عرض التخصصات المختارة -->
                            <div class="col-12">
                                <div id="selectedTagsContainer" class="selected-tags-box" style="display: none;">
                                    <label class="form-label fw-bold"><i class="fas fa-tags text-success me-2"></i>التخصصات المختارة:</label>
                                    <div id="selectedTagsList" class="tags-list"></div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label asp-for="StoreDescription" class="form-label">@Localizer["StoreDescription"]</label>
                                <textarea asp-for="StoreDescription" class="form-control" rows="3" placeholder="@Localizer["StoreDescriptionPlaceholder"]"></textarea>
                                <span asp-validation-for="StoreDescription" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl1" class="form-label">@Localizer["WebsiteUrl1"]</label>
                                <input asp-for="WebsiteUrl1" class="form-control" placeholder="https://example.com">
                                <span asp-validation-for="WebsiteUrl1" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl2" class="form-label">@Localizer["WebsiteUrl2"]</label>
                                <input asp-for="WebsiteUrl2" class="form-control" placeholder="https://facebook.com/yourstore">
                                <span asp-validation-for="WebsiteUrl2" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="WebsiteUrl3" class="form-label">@Localizer["WebsiteUrl3"]</label>
                                <input asp-for="WebsiteUrl3" class="form-control" placeholder="https://instagram.com/yourstore">
                                <span asp-validation-for="WebsiteUrl3" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Image -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-camera me-2"></i>@Localizer["ProfileImage"]</h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="ProfileImage" class="form-label">@Localizer["SelectProfileImage"]</label>
                                <input asp-for="ProfileImage" type="file" class="form-control" accept="image/*" onchange="previewProfileImage(this)">
                                <div class="form-text">@Localizer["ProfileImageNote"]</div>
                                <span asp-validation-for="ProfileImage" class="text-danger"></span>
                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <img id="preview" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;" alt="@Localizer["ImagePreview"]">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="form-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/Account/Login" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-2"></i>@Localizer["Back"]
                            </a>
                            <button type="submit" class="btn btn-custom btn-lg" id="submitBtn">
                                <i class="fas fa-user-plus me-2"></i>@Localizer["CreateAccount"]
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

        .form-section:last-child {
            border-bottom: none;
        }

    .section-title {
        color: #b3962d;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        flex: 1;
    }

    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .progress-step.completed .step-icon {
        background: #b3962d;
        color: white;
    }

    .progress-step.active .step-icon {
        background: var(--secondary-color);
        color: white;
    }

    .progress-line {
        height: 2px;
        background: #e9ecef;
        flex: 1;
        margin: 25px 20px 0;
    }

        .progress-line.completed {
            background: #b3962d;
        }

    .account-type-card {
        border: 2px solid var(--border-color);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
    }

        .account-type-card:hover {
            border-color: #b3962d;
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.1);
        }

        .account-type-card.selected {
            border-color: #b3962d;
            background: rgba(44, 90, 160, 0.05);
        }

        .account-type-card .card-body {
            padding: 2rem;
        }

    /* Specialization Dropdown */
    .spec-dropdown {
        position: relative;
        width: 100%;
    }

        .spec-dropdown.disabled .spec-dropdown-header {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

    .spec-dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        min-height: 42px;
    }

        .spec-dropdown-header:hover {
            border-color: #b3962d;
        }

        .spec-dropdown-header.active {
            border-color: #b3962d;
            box-shadow: 0 0 0 3px rgba(179, 150, 45, 0.15);
            border-radius: 6px 6px 0 0;
        }

        .spec-dropdown-header .count-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

    .spec-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #b3962d;
        border-top: none;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        z-index: 1050;
        display: none;
    }

        .spec-dropdown-menu.show {
            display: block;
        }

    .spec-search-box {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .spec-options-list {
        max-height: 250px;
        overflow-y: auto;
    }

    .spec-option {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
    }

        .spec-option:last-child {
            border-bottom: none;
        }

        .spec-option:hover {
            background: #f8f9fa;
        }

        .spec-option.selected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .spec-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 12px;
            accent-color: #28a745;
            cursor: pointer;
        }

        .spec-option .opt-label {
            flex: 1;
            font-size: 0.95rem;
            cursor: pointer;
        }

    .spec-empty-msg {
        padding: 30px;
        text-align: center;
        color: #6c757d;
    }

    .spec-actions {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-top: 1px solid #eee;
        background: #f8f9fa;
        border-radius: 0 0 6px 6px;
    }

    /* Selected Tags */
    .selected-tags-box {
        background: #f8fff8;
        border: 1px solid #c3e6cb;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .tag-item {
        display: inline-flex;
        align-items: center;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 25px;
        padding: 8px 15px;
        font-size: 0.9rem;
        animation: tagIn 0.3s ease;
    }

        .tag-item .tag-text {
            margin-left: 10px;
        }

        .tag-item .tag-remove {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }

            .tag-item .tag-remove:hover {
                background: rgba(255,255,255,0.5);
                transform: scale(1.1);
            }

        .tag-item.removing {
            animation: tagOut 0.3s ease forwards;
        }

    @@keyframes tagIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @@keyframes tagOut {
        from {
            opacity: 1;
            transform: scale(1);
        }

        to {
            opacity: 0;
            transform: scale(0.8);
        }
    }

    @@media (max-width: 768px) {
        .progress-step span {
            font-size: 0.8rem;
        }

        .progress-line {
            margin: 25px 10px 0;
        }
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var selectedCategories = new Map();
        var availableOptions = [];
        var currentCategoryName = '';
        var currentSubCategory1Name = '';
        var isDropdownOpen = false;

        var dropdownContainer, dropdownHeader, dropdownMenu, optionsList, searchInput;
        var headerText, dropdownArrow, btnSelectAll, btnClearAll;
        var selectedTagsContainer, selectedTagsList;

        document.addEventListener('DOMContentLoaded', function() {
            dropdownContainer = document.getElementById('subCategory2Container');
            dropdownHeader = document.getElementById('dropdownHeader');
            dropdownMenu = document.getElementById('dropdownMenu');
            optionsList = document.getElementById('optionsList');
            searchInput = document.getElementById('searchInput');
            headerText = document.getElementById('headerText');
            dropdownArrow = document.getElementById('dropdownArrow');
            btnSelectAll = document.getElementById('btnSelectAll');
            btnClearAll = document.getElementById('btnClearAll');
            selectedTagsContainer = document.getElementById('selectedTagsContainer');
            selectedTagsList = document.getElementById('selectedTagsList');

            // Account Type Selection
            document.querySelectorAll('.account-type-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.account-type-card').forEach(function(c) { c.classList.remove('selected'); });
                    this.classList.add('selected');
                    var userType = this.getAttribute('data-type');
                    document.getElementById('userTypeInput').value = userType;
                    var storeInfo = document.getElementById('storeInfo');

                    if (userType === '2') {
                        storeInfo.style.display = 'block';
                        document.getElementById('storeNameInput').required = true;
                    } else {
                        storeInfo.style.display = 'none';
                        document.getElementById('storeNameInput').required = false;
                        resetAllSelections();
                    }
                });
            });

            // Category Change
            $('#categorySelect').change(function() {
                var categoryId = $(this).val();
                currentCategoryName = $(this).find('option:selected').text();
                var $subCategory1 = $('#subCategory1Select');

                $subCategory1.html('<option value="">اختر الفئة الفرعية الأولى</option>').prop('disabled', true);
                dropdownContainer.classList.add('disabled');
                showEmptyMessage('اختر الفئة الفرعية أولاً');
                availableOptions = [];

                if (categoryId) {
                    $.ajax({
                        url: '/Requests/GetSubCategories1',
                        data: { categoryId: categoryId },
                        success: function(data) {
                            if (data && data.length > 0) {
                                $subCategory1.prop('disabled', false);
                                $.each(data, function(i, item) {
                                    $subCategory1.append($('<option>', { value: item.id, text: item.name }));
                                });
                            }
                        }
                    });
                }
            });

            // SubCategory1 Change
            $('#subCategory1Select').change(function() {
                var subCategory1Id = $(this).val();
                currentSubCategory1Name = $(this).find('option:selected').text();

                dropdownContainer.classList.add('disabled');
                showEmptyMessage('جاري التحميل...');
                availableOptions = [];

                if (subCategory1Id) {
                    $.ajax({
                        url: '/Requests/GetSubCategories2',
                        data: { subCategory1Id: subCategory1Id },
                        success: function(data) {
                            console.log('✅ التخصصات:', data);
                            if (data && data.length > 0) {
                                dropdownContainer.classList.remove('disabled');
                                availableOptions = data;
                                renderOptions(data);
                            } else {
                                showEmptyMessage('لا توجد تخصصات متاحة');
                            }
                        }
                    });
                }
            });

            // Dropdown Header Click
            dropdownHeader.addEventListener('click', function() {
                if (dropdownContainer.classList.contains('disabled')) return;
                toggleDropdown();
            });

            // Search Input
            searchInput.addEventListener('input', function() {
                filterOptions(this.value.toLowerCase());
            });

            // Select All
            btnSelectAll.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                availableOptions.forEach(function(opt) {
                    if (!selectedCategories.has(opt.id.toString())) {
                        var fullPath = currentCategoryName + ' > ' + currentSubCategory1Name + ' > ' + opt.name;
                        selectedCategories.set(opt.id.toString(), { id: opt.id.toString(), name: opt.name, path: fullPath });
                    }
                });
                renderOptions(availableOptions);
                updateHeader();
                renderSelectedTags();
                updateHiddenField();
            });

            // Clear All
            btnClearAll.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                availableOptions.forEach(function(opt) { selectedCategories.delete(opt.id.toString()); });
                renderOptions(availableOptions);
                updateHeader();
                renderSelectedTags();
                updateHiddenField();
            });

            // Close on outside click
            document.addEventListener('click', function(e) {
                if (dropdownContainer && !dropdownContainer.contains(e.target)) closeDropdown();
            });

            // Form Submit
            document.getElementById('createAccountForm').addEventListener('submit', function(e) {
                var userType = document.getElementById('userTypeInput').value;
                if (!userType) { e.preventDefault(); showAlert('@Localizer["SelectAccountType"]', 'warning'); return false; }

                if (userType === '2') {
                    var storeName = document.getElementById('storeNameInput').value;
                    if (!storeName.trim()) { e.preventDefault(); showAlert('@Localizer["EnterStoreName"]', 'warning'); return false; }
                    if (selectedCategories.size === 0) { e.preventDefault(); showAlert('يرجى اختيار تخصص واحد على الأقل', 'warning'); return false; }
                    updateHiddenField();
                }

                var submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> @Localizer["CreatingAccount"]';
            });

            // Date limits
            var dateInput = document.querySelector('[name="DateOfBirth"]');
            if (dateInput) {
                var eighteenYearsAgo = new Date();
                eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);
                dateInput.max = eighteenYearsAgo.toISOString().split('T')[0];
                var hundredYearsAgo = new Date();
                hundredYearsAgo.setFullYear(hundredYearsAgo.getFullYear() - 100);
                dateInput.min = hundredYearsAgo.toISOString().split('T')[0];
            }
        });

        function showEmptyMessage(msg) {
            if (optionsList) optionsList.innerHTML = '<div class="spec-empty-msg"><i class="fas fa-info-circle me-2"></i>' + msg + '</div>';
        }

        function renderOptions(options) {
            if (!optionsList) return;
            optionsList.innerHTML = '';
            if (!options || options.length === 0) { showEmptyMessage('لا توجد تخصصات'); return; }

            options.forEach(function(opt) {
                var isSelected = selectedCategories.has(opt.id.toString());
                var div = document.createElement('div');
                div.className = 'spec-option' + (isSelected ? ' selected' : '');
                div.setAttribute('data-id', opt.id);
                div.innerHTML = '<input type="checkbox" ' + (isSelected ? 'checked' : '') + '><span class="opt-label">' + opt.name + '</span>';

                div.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var cb = this.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    handleOptionClick(opt.id.toString(), opt.name, cb.checked);
                });
                optionsList.appendChild(div);
            });
        }

        function filterOptions(term) {
            var filtered = availableOptions.filter(function(opt) { return opt.name.toLowerCase().includes(term); });
            if (filtered.length === 0) showEmptyMessage('لا توجد نتائج');
            else renderOptions(filtered);
        }

        function handleOptionClick(id, name, isChecked) {
            var fullPath = currentCategoryName + ' > ' + currentSubCategory1Name + ' > ' + name;
            if (isChecked) selectedCategories.set(id, { id: id, name: name, path: fullPath });
            else selectedCategories.delete(id);

            var item = optionsList.querySelector('[data-id="' + id + '"]');
            if (item) item.classList.toggle('selected', isChecked);

            updateHeader();
            renderSelectedTags();
            updateHiddenField();
        }

        function toggleDropdown() {
            isDropdownOpen = !isDropdownOpen;
            if (dropdownMenu) dropdownMenu.classList.toggle('show', isDropdownOpen);
            if (dropdownHeader) dropdownHeader.classList.toggle('active', isDropdownOpen);
            if (dropdownArrow) dropdownArrow.style.transform = isDropdownOpen ? 'rotate(180deg)' : 'rotate(0)';
            if (isDropdownOpen && searchInput) searchInput.focus();
        }

        function closeDropdown() {
            isDropdownOpen = false;
            if (dropdownMenu) dropdownMenu.classList.remove('show');
            if (dropdownHeader) dropdownHeader.classList.remove('active');
            if (dropdownArrow) dropdownArrow.style.transform = 'rotate(0)';
        }

        function updateHeader() {
            if (!headerText) return;
            var count = selectedCategories.size;
            headerText.innerHTML = count > 0 ? '<span class="count-badge">' + count + ' تخصص مختار</span>' : 'اختر التخصصات الدقيقة...';
        }

        function renderSelectedTags() {
            if (!selectedTagsList || !selectedTagsContainer) return;
            selectedTagsList.innerHTML = '';

            if (selectedCategories.size > 0) {
                selectedTagsContainer.style.display = 'block';
                selectedCategories.forEach(function(cat, id) {
                    var tag = document.createElement('div');
                    tag.className = 'tag-item';
                    tag.setAttribute('data-id', id);
                    tag.innerHTML = '<i class="fas fa-tag"></i><span class="tag-text">' + cat.path + '</span><button type="button" class="tag-remove" onclick="removeTag(\'' + id + '\')"><i class="fas fa-times"></i></button>';
                    selectedTagsList.appendChild(tag);
                });
            } else {
                selectedTagsContainer.style.display = 'none';
            }
        }

        function removeTag(id) {
            var tag = selectedTagsList.querySelector('[data-id="' + id + '"]');
            if (tag) {
                tag.classList.add('removing');
                setTimeout(function() {
                    selectedCategories.delete(id);
                    renderSelectedTags();
                    updateHeader();
                    updateHiddenField();
                    if (optionsList) {
                        var item = optionsList.querySelector('[data-id="' + id + '"]');
                        if (item) { item.classList.remove('selected'); var cb = item.querySelector('input'); if (cb) cb.checked = false; }
                    }
                }, 300);
            }
        }

        function updateHiddenField() {
            var ids = [];
            selectedCategories.forEach(function(cat, id) { ids.push(parseInt(id)); });
            var field = document.getElementById('storeCategoriesHidden');
            if (field) field.value = JSON.stringify(ids);
            console.log('📋 Selected:', ids);
        }

        function resetAllSelections() {
            selectedCategories.clear();
            document.getElementById('categorySelect').value = '';
            var sub1 = document.getElementById('subCategory1Select');
            if (sub1) { sub1.innerHTML = '<option value="">اختر الفئة الفرعية الأولى</option>'; sub1.disabled = true; }
            if (dropdownContainer) dropdownContainer.classList.add('disabled');
            showEmptyMessage('اختر الفئة الفرعية أولاً');
            var field = document.getElementById('storeCategoriesHidden');
            if (field) field.value = '';
            if (selectedTagsContainer) selectedTagsContainer.style.display = 'none';
            updateHeader();
            availableOptions = [];
        }

        function previewProfileImage(input) {
            var preview = document.getElementById('preview');
            var container = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                if (input.files[0].size > 5 * 1024 * 1024) { showAlert('@Localizer["ImageTooLarge"]', 'warning'); input.value = ''; container.style.display = 'none'; return; }
                var reader = new FileReader();
                reader.onload = function(e) { preview.src = e.target.result; container.style.display = 'block'; };
                reader.readAsDataURL(input.files[0]);
            } else { container.style.display = 'none'; }
        }

        function showAlert(message, type) {
            var div = document.createElement('div');
            div.className = 'alert alert-' + type + ' alert-dismissible fade show';
            div.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;max-width:350px;box-shadow:0 4px 15px rgba(0,0,0,0.2);';
            div.innerHTML = '<i class="fas fa-' + (type === 'warning' ? 'exclamation-triangle' : 'info-circle') + ' me-2"></i>' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            document.body.appendChild(div);
            setTimeout(function() { if (div.parentNode) div.remove(); }, 5000);
        }
    </script>
}
