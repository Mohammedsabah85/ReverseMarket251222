@using ReverseMarket.Controllers
@using ReverseMarket.Models.Identity
@model EditProfileViewModel
@{
    ViewData["Title"] = "تعديل الملف الشخصي";
    var isSeller = Model.UserType == UserType.Seller;
    var isBuyer = Model.UserType == UserType.Buyer;
}

<div class="container-custom">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card-custom">
                <div class="text-center mb-4">
                    <i class="fas fa-user-edit fa-3x text-primary mb-3"></i>
                    <h1 class="h3 text-primary">تعديل الملف الشخصي</h1>
                    <p class="text-muted">قم بتحديث معلوماتك الشخصية</p>
                    <div class="mt-2">
                        @if (isSeller)
                        {
                            <span class="badge bg-success fs-6"><i class="fas fa-store me-1"></i>حساب بائع</span>
                        }
                        else
                        {
                            <span class="badge bg-primary fs-6"><i class="fas fa-shopping-cart me-1"></i>حساب مشتري</span>
                        }
                    </div>
                </div>

                <form asp-action="Edit" method="post" id="editProfileForm" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <!-- Profile Image -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-camera me-2"></i>الصورة الشخصية</h5>
                        <div class="row justify-content-center">
                            <div class="col-md-6 text-center">
                                <div class="profile-image-container mb-3">
                                    @if (!string.IsNullOrEmpty(Model.ProfileImage))
                                    {
                                        <img src="@Model.ProfileImage" id="profileImagePreview" class="rounded-circle profile-preview" alt="صورتك">
                                    }
                                    else
                                    {
                                        <div id="profileImagePreview" class="bg-primary text-white rounded-circle profile-preview d-inline-flex align-items-center justify-content-center">
                                            <i class="fas fa-user fa-4x"></i>
                                        </div>
                                    }
                                </div>
                                <div class="mb-3">
                                    <label for="profileImageInput" class="btn btn-outline-primary">
                                        <i class="fas fa-upload me-2"></i>اختر صورة جديدة
                                    </label>
                                    <input type="file" id="profileImageInput" name="ProfileImageFile" accept="image/*" class="d-none" onchange="previewImage(this)">
                                </div>
                                <small class="text-muted d-block">الحجم الأقصى: 5MB | JPG, PNG, GIF</small>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Info -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-user me-2"></i>المعلومات الشخصية</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label">الاسم الأول *</label>
                                <input asp-for="FirstName" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label">اسم العائلة *</label>
                                <input asp-for="LastName" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label">البريد الإلكتروني</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="اختياري">
                            </div>
                            <div class="col-md-6">
                                <label asp-for="PhoneNumber" class="form-label">رقم الهاتف *</label>
                                <input asp-for="PhoneNumber" class="form-control" disabled>
                                <small class="form-text text-muted">لا يمكن تغيير رقم الهاتف</small>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="DateOfBirth" class="form-label">تاريخ الميلاد *</label>
                                <input asp-for="DateOfBirth" type="date" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Gender" class="form-label">الجنس *</label>
                                <select asp-for="Gender" class="form-control" required>
                                    <option value="">اختر</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="form-section">
                        <h5 class="section-title"><i class="fas fa-map-marker-alt me-2"></i>معلومات الموقع</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="City" class="form-label">المحافظة *</label>
                                <select asp-for="City" class="form-control" required>
                                    <option value="">اختر</option>
                                    <option value="بغداد">بغداد</option>
                                    <option value="البصرة">البصرة</option>
                                    <option value="أربيل">أربيل</option>
                                    <option value="النجف">النجف</option>
                                    <option value="كربلاء">كربلاء</option>
                                    <option value="الموصل">الموصل</option>
                                    <option value="السليمانية">السليمانية</option>
                                    <option value="بابل">بابل</option>
                                    <option value="دهوك">دهوك</option>
                                    <option value="كركوك">كركوك</option>
                                    <option value="الأنبار">الأنبار</option>
                                    <option value="ديالى">ديالى</option>
                                    <option value="صلاح الدين">صلاح الدين</option>
                                    <option value="واسط">واسط</option>
                                    <option value="ذي قار">ذي قار</option>
                                    <option value="المثنى">المثنى</option>
                                    <option value="القادسية">القادسية</option>
                                    <option value="ميسان">ميسان</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="District" class="form-label">المنطقة *</label>
                                <input asp-for="District" class="form-control" placeholder="مثال: الكرادة" required>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Location" class="form-label">العنوان التفصيلي</label>
                                <input asp-for="Location" class="form-control" placeholder="اختياري">
                            </div>
                        </div>
                    </div>

                    @* تفضيلات التواصل - للمشترين *@
                    @if (isBuyer)
                    {
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-address-book me-2"></i>تفضيلات التواصل</h5>
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-info-circle me-2"></i>حدد طرق التواصل المفضلة.
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4 col-6">
                                    <div class="contact-option-card @(Model.AllowPhoneCall ? "active" : "")">
                                        <div class="form-check form-switch">
                                            <input asp-for="AllowPhoneCall" class="form-check-input contact-toggle" type="checkbox" id="allowPhoneCallSwitch">
                                            <label class="form-check-label" for="allowPhoneCallSwitch">
                                                <i class="fas fa-phone-alt contact-icon text-primary"></i><span>الاتصال</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="contact-option-card @(Model.AllowWhatsApp ? "active" : "")">
                                        <div class="form-check form-switch">
                                            <input asp-for="AllowWhatsApp" class="form-check-input contact-toggle" type="checkbox" id="allowWhatsAppSwitch">
                                            <label class="form-check-label" for="allowWhatsAppSwitch">
                                                <i class="fab fa-whatsapp contact-icon text-success"></i><span>واتساب</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="contact-option-card @(Model.AllowEmail ? "active" : "")">
                                        <div class="form-check form-switch">
                                            <input asp-for="AllowEmail" class="form-check-input contact-toggle" type="checkbox" id="allowEmailSwitch">
                                            <label class="form-check-label" for="allowEmailSwitch">
                                                <i class="fas fa-envelope contact-icon text-info"></i><span>البريد</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="contact-option-card @(Model.AllowSMS ? "active" : "")">
                                        <div class="form-check form-switch">
                                            <input asp-for="AllowSMS" class="form-check-input contact-toggle" type="checkbox" id="allowSMSSwitch">
                                            <label class="form-check-label" for="allowSMSSwitch">
                                                <i class="fas fa-sms contact-icon text-warning"></i><span>SMS</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="contact-option-card @(Model.AllowInAppChat ? "active" : "")">
                                        <div class="form-check form-switch">
                                            <input asp-for="AllowInAppChat" class="form-check-input contact-toggle" type="checkbox" id="allowInAppChatSwitch">
                                            <label class="form-check-label" for="allowInAppChatSwitch">
                                                <i class="fas fa-comments contact-icon text-secondary"></i><span>الدردشة</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="noContactMethodWarning" class="alert alert-warning mt-3" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>يجب تفعيل وسيلة تواصل واحدة على الأقل.
                            </div>
                            <div class="row g-3 mt-3">
                                <div class="col-md-6" id="whatsappAlternativeSection">
                                    <label asp-for="AlternativeWhatsApp" class="form-label"><i class="fab fa-whatsapp text-success me-1"></i>رقم واتساب بديل</label>
                                    <div class="input-group">
                                        <span class="input-group-text">+964</span>
                                        <input asp-for="AlternativeWhatsApp" class="form-control" placeholder="اختياري">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="PreferredContactTime" class="form-label"><i class="fas fa-clock text-primary me-1"></i>أفضل وقت</label>
                                    <select asp-for="PreferredContactTime" class="form-control">
                                        <option value="">-- اختر --</option>
                                        <option value="صباحاً">صباحاً</option>
                                        <option value="ظهراً">ظهراً</option>
                                        <option value="مساءً">مساءً</option>
                                        <option value="أي وقت">أي وقت</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label asp-for="ContactNotes" class="form-label"><i class="fas fa-sticky-note text-warning me-1"></i>ملاحظات</label>
                                    <textarea asp-for="ContactNotes" class="form-control" rows="2" placeholder="ملاحظات إضافية..."></textarea>
                                    <small class="form-text text-muted"><span id="contactNotesCount">0</span>/500</small>
                                </div>
                            </div>
                        </div>
                    }

                    @* معلومات المتجر - للبائعين *@
                    @if (isSeller)
                    {
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-store me-2"></i>معلومات المتجر</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="StoreName" class="form-label">اسم المتجر *</label>
                                    <input asp-for="StoreName" class="form-control" required>
                                </div>
                                <div class="col-12">
                                    <label asp-for="StoreDescription" class="form-label">وصف المتجر</label>
                                    <textarea asp-for="StoreDescription" class="form-control" rows="3" placeholder="وصف مختصر..."></textarea>
                                </div>
                                @if (Model.HasPendingUrlChanges)
                                {
                                    <div class="col-12">
                                        <div class="alert alert-warning"><i class="fas fa-clock me-2"></i>لديك روابط معلقة</div>
                                    </div>
                                }
                                <div class="col-md-4">
                                    <label asp-for="WebsiteUrl1" class="form-label">رابط 1</label>
                                    <input asp-for="WebsiteUrl1" class="form-control" placeholder="https://...">
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="WebsiteUrl2" class="form-label">رابط 2</label>
                                    <input asp-for="WebsiteUrl2" class="form-control" placeholder="https://...">
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="WebsiteUrl3" class="form-label">رابط 3</label>
                                    <input asp-for="WebsiteUrl3" class="form-control" placeholder="https://...">
                                </div>
                            </div>
                        </div>

                        @* تخصصات المتجر *@
                        <div class="form-section">
                            <h5 class="section-title"><i class="fas fa-tags me-2"></i>تخصصات المتجر</h5>

                            @if (Model.CurrentStoreCategories != null && Model.CurrentStoreCategories.Any())
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="fas fa-check-circle text-success me-2"></i>التخصصات الحالية:</label>
                                    <div id="existingTagsContainer" class="existing-tags-box">
                                        <div id="existingTagsList" class="tags-list">
                                            @foreach (var cat in Model.CurrentStoreCategories)
                                            {
                                                <div class="tag-item existing" data-id="@cat.SubCategory2Id" data-sub2-id="@cat.SubCategory2Id">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span class="tag-text">@cat.FullPath</span>
                                                    <button type="button" class="tag-remove" onclick="removeExistingCategory('@cat.SubCategory2Id', '@cat.SubCategory2Id')"><i class="fas fa-times"></i></button>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mb-4"><i class="fas fa-info-circle me-2"></i>لم يتم تحديد تخصصات بعد.</div>
                            }

                            <div class="alert alert-light border mb-4">
                                <i class="fas fa-lightbulb text-warning me-2"></i><strong>نصيحة:</strong> اختر تخصصات متعددة للحصول على طلبات أكثر.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">الفئة الأساسية</label>
                                    <select id="categorySelect" class="form-control">
                                        <option value="">اختر الفئة</option>
                                        @foreach (var category in ViewBag.Categories as List<Category>)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">الفئة الفرعية</label>
                                    <select id="subCategory1Select" class="form-control" disabled>
                                        <option value="">اختر الفئة الفرعية</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">التخصص الدقيق</label>
                                    <div id="subCategory2Container" class="spec-dropdown disabled">
                                        <div class="spec-dropdown-header" id="dropdownHeader">
                                            <span id="headerText">اختر التخصصات...</span>
                                            <i class="fas fa-chevron-down" id="dropdownArrow"></i>
                                        </div>
                                        <div class="spec-dropdown-menu" id="dropdownMenu">
                                            <div class="spec-search-box">
                                                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="ابحث...">
                                            </div>
                                            <div class="spec-options-list" id="optionsList">
                                                <div class="spec-empty-msg"><i class="fas fa-info-circle me-2"></i>اختر الفئة الفرعية أولاً</div>
                                            </div>
                                            <div class="spec-actions">
                                                <button type="button" class="btn btn-sm btn-outline-success" id="btnSelectAll"><i class="fas fa-check-double me-1"></i>تحديد الكل</button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnClearAll"><i class="fas fa-times me-1"></i>مسح الكل</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text"><i class="fas fa-hand-pointer me-1"></i>اضغط للاختيار المتعدد</div>
                                </div>

                                <input type="hidden" asp-for="StoreCategories" id="storeCategoriesHidden" />

                                <div class="col-12">
                                    <div id="newTagsContainer" class="new-tags-box" style="display: none;">
                                        <label class="form-label fw-bold"><i class="fas fa-plus-circle text-primary me-2"></i>التخصصات الجديدة:</label>
                                        <div id="newTagsList" class="tags-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Submit -->
                    <div class="form-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="/Profile" class="btn btn-outline-secondary"><i class="fas fa-times me-2"></i>إلغاء</a>
                            <button type="submit" class="btn btn-custom btn-lg" id="submitBtn"><i class="fas fa-save me-2"></i>حفظ التعديلات</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

        .form-section:last-child {
            border-bottom: none;
        }

    .section-title {
        color: #b3962d;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .profile-image-container {
        position: relative;
        display: inline-block;
    }

    .profile-preview {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border: 4px solid #b3962d;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

        .profile-preview.d-inline-flex {
            display: inline-flex !important;
        }

    .contact-option-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
    }

        .contact-option-card:hover {
            border-color: #b3962d;
        }

        .contact-option-card.active {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }

        .contact-option-card .form-check-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .contact-option-card .contact-icon {
            font-size: 1.5rem;
            width: 35px;
            text-align: center;
        }

        .contact-option-card .form-check-input {
            width: 50px;
            height: 26px;
        }

            .contact-option-card .form-check-input:checked {
                background-color: #4caf50;
                border-color: #4caf50;
            }

        .contact-option-card:not(.active) {
            opacity: 0.7;
        }

            .contact-option-card:not(.active) .contact-icon {
                filter: grayscale(100%);
            }

    .spec-dropdown {
        position: relative;
        width: 100%;
    }

        .spec-dropdown.disabled .spec-dropdown-header {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

    .spec-dropdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        min-height: 42px;
    }

        .spec-dropdown-header:hover {
            border-color: #b3962d;
        }

        .spec-dropdown-header.active {
            border-color: #b3962d;
            box-shadow: 0 0 0 3px rgba(179, 150, 45, 0.15);
            border-radius: 6px 6px 0 0;
        }

        .spec-dropdown-header .count-badge {
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

    .spec-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #b3962d;
        border-top: none;
        border-radius: 0 0 6px 6px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        z-index: 1050;
        display: none;
    }

        .spec-dropdown-menu.show {
            display: block;
        }

    .spec-search-box {
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .spec-options-list {
        max-height: 250px;
        overflow-y: auto;
    }

    .spec-option {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
    }

        .spec-option:hover {
            background: #f8f9fa;
        }

        .spec-option.selected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .spec-option.disabled-opt {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f0f0f0;
        }

        .spec-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 12px;
            accent-color: #28a745;
        }

        .spec-option .opt-label {
            flex: 1;
            font-size: 0.95rem;
        }

    .spec-empty-msg {
        padding: 30px;
        text-align: center;
        color: #6c757d;
    }

    .spec-actions {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }

    .existing-tags-box {
        background: #f0fff0;
        border: 1px solid #c3e6cb;
        border-radius: 10px;
        padding: 15px;
    }

    .new-tags-box {
        background: #f0f8ff;
        border: 1px solid #b8daff;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .tag-item {
        display: inline-flex;
        align-items: center;
        border-radius: 25px;
        padding: 8px 15px;
        font-size: 0.9rem;
        animation: tagIn 0.3s ease;
    }

        .tag-item.existing {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .tag-item.new {
            background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
            color: white;
        }

        .tag-item .tag-text {
            margin-left: 8px;
            margin-right: 8px;
        }

        .tag-item .tag-remove {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }

            .tag-item .tag-remove:hover {
                background: rgba(255,255,255,0.5);
                transform: scale(1.1);
            }

        .tag-item.removing {
            animation: tagOut 0.3s ease forwards;
        }
    @@keyframes tagIn {
        from

    {
        opacity: 0;
        transform: scale(0.8);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }

    }
    @@keyframes tagOut {
        from

    {
        opacity: 1;
    }

    to {
        opacity: 0;
        transform: scale(0.8);
    }

    }</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var existingCategories = new Map();
        var newSelectedCategories = new Map();
        var availableOptions = [];
        var currentCategoryName = '';
        var currentSubCategory1Name = '';
        var isDropdownOpen = false;
        var dropdownContainer, dropdownHeader, dropdownMenu, optionsList, searchInput, headerText, dropdownArrow, btnSelectAll, btnClearAll, newTagsContainer, newTagsList;

        @* FIX: Use SubCategory2Id instead of Id, since StoreCategoryDisplay does not have Id property *@
        @if (Model.CurrentStoreCategories != null && Model.CurrentStoreCategories.Any())
        {
            foreach (var cat in Model.CurrentStoreCategories)
            {
                <text>existingCategories.set('@cat.SubCategory2Id', { subCategory2Id: '@cat.SubCategory2Id', path: '@cat.FullPath' });</text>
            }
        }

        function previewImage(input) {
            var preview = document.getElementById('profileImagePreview');
            if (input.files && input.files[0]) {
                if (input.files[0].size > 5 * 1024 * 1024) { alert('الحجم كبير جداً!'); input.value = ''; return; }
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (preview.tagName === 'IMG') preview.src = e.target.result;
                    else { var img = document.createElement('img'); img.src = e.target.result; img.id = 'profileImagePreview'; img.className = 'rounded-circle profile-preview'; preview.parentNode.replaceChild(img, preview); }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            dropdownContainer = document.getElementById('subCategory2Container');
            dropdownHeader = document.getElementById('dropdownHeader');
            dropdownMenu = document.getElementById('dropdownMenu');
            optionsList = document.getElementById('optionsList');
            searchInput = document.getElementById('searchInput');
            headerText = document.getElementById('headerText');
            dropdownArrow = document.getElementById('dropdownArrow');
            btnSelectAll = document.getElementById('btnSelectAll');
            btnClearAll = document.getElementById('btnClearAll');
            newTagsContainer = document.getElementById('newTagsContainer');
            newTagsList = document.getElementById('newTagsList');

            var contactToggles = document.querySelectorAll('.contact-toggle');
            contactToggles.forEach(function(t) {
                t.addEventListener('change', function() {
                    this.closest('.contact-option-card').classList.toggle('active', this.checked);
                    checkContactMethods();
                    var ws = document.getElementById('whatsappAlternativeSection');
                    var wt = document.getElementById('allowWhatsAppSwitch');
                    if (ws && wt) ws.style.display = wt.checked ? 'block' : 'none';
                });
            });
            function checkContactMethods() {
                var w = document.getElementById('noContactMethodWarning');
                if (w) w.style.display = Array.from(contactToggles).some(function(t) { return t.checked; }) ? 'none' : 'block';
            }
            checkContactMethods();
            var ws = document.getElementById('whatsappAlternativeSection');
            var wt = document.getElementById('allowWhatsAppSwitch');
            if (ws && wt) ws.style.display = wt.checked ? 'block' : 'none';

            var cn = document.querySelector('[name="ContactNotes"]');
            var cc = document.getElementById('contactNotesCount');
            if (cn && cc) { cc.textContent = cn.value.length; cn.addEventListener('input', function() { cc.textContent = this.value.length; if (this.value.length > 500) { this.value = this.value.substring(0, 500); cc.textContent = 500; } }); }

            $('#categorySelect').change(function() {
                var id = $(this).val();
                currentCategoryName = $(this).find('option:selected').text();
                $('#subCategory1Select').html('<option value="">اختر</option>').prop('disabled', true);
                if (dropdownContainer) dropdownContainer.classList.add('disabled');
                showEmptyMessage('اختر الفئة الفرعية أولاً');
                availableOptions = [];
                if (id) {
                    $.get('/Profile/GetSubCategories1', { categoryId: id }, function(data) {
                        if (data && data.length > 0) { $('#subCategory1Select').prop('disabled', false); $.each(data, function(i, item) { $('#subCategory1Select').append($('<option>', { value: item.id, text: item.name })); }); }
                    });
                }
            });

            $('#subCategory1Select').change(function() {
                var id = $(this).val();
                currentSubCategory1Name = $(this).find('option:selected').text();
                if (dropdownContainer) dropdownContainer.classList.add('disabled');
                showEmptyMessage('جاري التحميل...');
                availableOptions = [];
                if (id) {
                    $.get('/Profile/GetSubCategories2', { subCategory1Id: id }, function(data) {
                        if (data && data.length > 0) { dropdownContainer.classList.remove('disabled'); availableOptions = data; renderOptions(data); }
                        else showEmptyMessage('لا توجد تخصصات');
                    });
                }
            });

            if (dropdownHeader) dropdownHeader.addEventListener('click', function() { if (!dropdownContainer.classList.contains('disabled')) toggleDropdown(); });
            if (searchInput) searchInput.addEventListener('input', function() { filterOptions(this.value.toLowerCase()); });
            if (btnSelectAll) btnSelectAll.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); availableOptions.forEach(function(opt) { if (!existingCategories.has(opt.id.toString()) && !newSelectedCategories.has(opt.id.toString())) { newSelectedCategories.set(opt.id.toString(), { id: opt.id.toString(), name: opt.name, path: currentCategoryName + ' > ' + currentSubCategory1Name + ' > ' + opt.name }); } }); renderOptions(availableOptions); updateHeader(); renderNewTags(); updateHiddenField(); });
            if (btnClearAll) btnClearAll.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); availableOptions.forEach(function(opt) { newSelectedCategories.delete(opt.id.toString()); }); renderOptions(availableOptions); updateHeader(); renderNewTags(); updateHiddenField(); });
            document.addEventListener('click', function(e) { if (dropdownContainer && !dropdownContainer.contains(e.target)) closeDropdown(); });

            document.getElementById('editProfileForm').addEventListener('submit', function(e) {
                var isBuyer = @(isBuyer ? "true" : "false");
                if (isBuyer && !Array.from(contactToggles).some(function(t) { return t.checked; })) { e.preventDefault(); alert('يجب تفعيل وسيلة تواصل واحدة على الأقل'); return false; }
                updateHiddenField();
                var btn = document.getElementById('submitBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
            });

            updateHiddenField();
        });

        function showEmptyMessage(msg) { if (optionsList) optionsList.innerHTML = '<div class="spec-empty-msg"><i class="fas fa-info-circle me-2"></i>' + msg + '</div>'; }
        function renderOptions(options) {
            if (!optionsList) return;
            optionsList.innerHTML = '';
            if (!options || options.length === 0) { showEmptyMessage('لا توجد تخصصات'); return; }
            options.forEach(function(opt) {
                var isExisting = existingCategories.has(opt.id.toString());
                var isNew = newSelectedCategories.has(opt.id.toString());
                var div = document.createElement('div');
                div.className = 'spec-option' + (isNew ? ' selected' : '') + (isExisting ? ' disabled-opt' : '');
                div.setAttribute('data-id', opt.id);
                div.innerHTML = '<input type="checkbox" ' + (isNew ? 'checked' : '') + (isExisting ? ' disabled' : '') + '><span class="opt-label">' + opt.name + (isExisting ? ' <small class="text-muted">(محدد)</small>' : '') + '</span>';
                if (!isExisting) div.addEventListener('click', function(e) { e.stopPropagation(); var cb = this.querySelector('input'); cb.checked = !cb.checked; handleOptionClick(opt.id.toString(), opt.name, cb.checked); });
                optionsList.appendChild(div);
            });
        }
        function filterOptions(term) { var f = availableOptions.filter(function(o) { return o.name.toLowerCase().includes(term); }); if (f.length === 0) showEmptyMessage('لا توجد نتائج'); else renderOptions(f); }
        function handleOptionClick(id, name, checked) { var path = currentCategoryName + ' > ' + currentSubCategory1Name + ' > ' + name; if (checked) newSelectedCategories.set(id, { id: id, name: name, path: path }); else newSelectedCategories.delete(id); var item = optionsList.querySelector('[data-id="' + id + '"]'); if (item) item.classList.toggle('selected', checked); updateHeader(); renderNewTags(); updateHiddenField(); }
        function toggleDropdown() { isDropdownOpen = !isDropdownOpen; if (dropdownMenu) dropdownMenu.classList.toggle('show', isDropdownOpen); if (dropdownHeader) dropdownHeader.classList.toggle('active', isDropdownOpen); if (dropdownArrow) dropdownArrow.style.transform = isDropdownOpen ? 'rotate(180deg)' : 'rotate(0)'; if (isDropdownOpen && searchInput) searchInput.focus(); }
        function closeDropdown() { isDropdownOpen = false; if (dropdownMenu) dropdownMenu.classList.remove('show'); if (dropdownHeader) dropdownHeader.classList.remove('active'); if (dropdownArrow) dropdownArrow.style.transform = 'rotate(0)'; }
        function updateHeader() { if (!headerText) return; var c = newSelectedCategories.size; headerText.innerHTML = c > 0 ? '<span class="count-badge">' + c + ' جديد</span>' : 'اختر التخصصات...'; }
        function renderNewTags() { if (!newTagsList || !newTagsContainer) return; newTagsList.innerHTML = ''; if (newSelectedCategories.size > 0) { newTagsContainer.style.display = 'block'; newSelectedCategories.forEach(function(cat, id) { var tag = document.createElement('div'); tag.className = 'tag-item new'; tag.setAttribute('data-id', id); tag.innerHTML = '<i class="fas fa-plus-circle"></i><span class="tag-text">' + cat.path + '</span><button type="button" class="tag-remove" onclick="removeNewTag(\'' + id + '\')"><i class="fas fa-times"></i></button>'; newTagsList.appendChild(tag); }); } else newTagsContainer.style.display = 'none'; }
        function removeNewTag(id) { var tag = newTagsList.querySelector('[data-id="' + id + '"]'); if (tag) { tag.classList.add('removing'); setTimeout(function() { newSelectedCategories.delete(id); renderNewTags(); updateHeader(); updateHiddenField(); var item = optionsList ? optionsList.querySelector('[data-id="' + id + '"]') : null; if (item) { item.classList.remove('selected'); var cb = item.querySelector('input'); if (cb) cb.checked = false; } }, 300); } }
        function removeExistingCategory(categoryId, subCategory2Id) { if (!confirm('هل أنت متأكد؟')) return; $.ajax({ url: '/Profile/RemoveCategory', method: 'POST', data: { categoryId: categoryId }, headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }, success: function(data) { if (data.success) { var tag = document.querySelector('#existingTagsList .tag-item[data-id="' + categoryId + '"]'); if (tag) { tag.classList.add('removing'); setTimeout(function() { tag.remove(); existingCategories.delete(subCategory2Id); updateHiddenField(); if (existingCategories.size === 0) { var c = document.getElementById('existingTagsContainer'); if (c) c.parentElement.style.display = 'none'; } }, 300); } showAlert(data.message, 'success'); } else showAlert(data.message, 'error'); }, error: function() { showAlert('حدث خطأ', 'error'); } }); }
        function updateHiddenField() { var ids = []; existingCategories.forEach(function(c) { if (c.subCategory2Id) ids.push(parseInt(c.subCategory2Id)); }); newSelectedCategories.forEach(function(c, id) { ids.push(parseInt(id)); }); var f = document.getElementById('storeCategoriesHidden'); if (f) f.value = JSON.stringify(ids); }
        function showAlert(msg, type) { var d = document.createElement('div'); d.className = 'alert alert-' + (type === 'error' ? 'danger' : type) + ' alert-dismissible fade show'; d.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;max-width:350px;box-shadow:0 4px 15px rgba(0,0,0,0.2);'; d.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' + msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>'; document.body.appendChild(d); setTimeout(function() { if (d.parentNode) d.remove(); }, 4000); }
    </script>
}
